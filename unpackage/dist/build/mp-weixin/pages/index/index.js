"use strict";const e=require("../../common/vendor.js"),i=require("../../common/assets.js"),n={data:()=>({title:"Hello",tmplIds:["WhDz7V9NVqZi6Fo3K0-CB7TJuOlU21LhOlo9YaoXsc8"],token:"",tokenExpired:"",uid:"",loggingIn:!1}),onLoad(){},methods:{requestSubscribe(){this.tmplIds&&0!==this.tmplIds.length?e.index.requestSubscribeMessage({tmplIds:this.tmplIds,success:async i=>{const n=Object.values(i).some((e=>"accept"===e));e.index.showToast({title:n?"订阅成功":"未订阅通知",icon:n?"success":"none"}),n&&await this.showOpenidAfterSubscribe()},fail:i=>{console.error("requestSubscribeMessage fail",i),e.index.showToast({title:"订阅失败，请稍后重试",icon:"none"})}}):e.index.showToast({title:"请先配置模板 ID",icon:"none"})},async weixinLogin(){if(!this.loggingIn){this.loggingIn=!0;try{const i=await new Promise(((i,n)=>{e.index.login({provider:"weixin",success:i,fail:n})})),n=e.tr.importObject("uni-id-co"),o=await n.loginByWeixin({code:i.code});if(o.errCode)throw new Error(o.errMsg||"登录失败");const{token:t,tokenExpired:s}=o.newToken||{};this.token=t,this.tokenExpired=s,this.uid=o.uid,e.index.setStorageSync("uni_id_token",t),e.index.setStorageSync("uni_id_token_expired",s),e.index.showToast({title:"登录成功",icon:"success"})}catch(i){console.error("weixinLogin error",i),e.index.showToast({title:i.message||"微信登录失败",icon:"none"})}finally{this.loggingIn=!1}}},async showOpenidAfterSubscribe(){if(this.uid){e.index.showLoading({title:"获取 openid..."});try{const{result:i}=await e.tr.callFunction({name:"getUserOpenid",data:{uid:this.uid}}),{openid:n,errMsg:o}=i||{};if(!n)throw new Error(o||"未能获取 openid");console.log("当前 openid:",n),e.index.showToast({title:`openid: ${n}`,icon:"none",duration:4e3})}catch(i){console.error("showOpenidAfterSubscribe error",i),e.index.showToast({title:i.message||"获取 openid 失败",icon:"none"})}finally{e.index.hideLoading()}}else e.index.showToast({title:"请先登录再获取 openid",icon:"none"})}}};const o=e._export_sfc(n,[["render",function(n,o,t,s,r,c){return e.e({a:i._imports_0,b:e.t(r.title),c:e.o(((...e)=>c.requestSubscribe&&c.requestSubscribe(...e))),d:r.loggingIn,e:e.o(((...e)=>c.weixinLogin&&c.weixinLogin(...e))),f:r.token},r.token?{g:e.t(r.uid),h:e.t(r.token),i:e.t(r.tokenExpired)}:{})}]]);wx.createPage(o);
